# Microtastic Project Rules

## Project Overview
Microtastic is a small tooling package for pure ES6 browser development. It provides a CLI for bundling dependencies, running a dev server, and building production-ready applications.

## Tech Stack
- **Runtime**: Node.js (ES6 modules)
- **Bundler**: Rollup with plugins (commonjs, node-resolve, terser, polyfill-node)
- **Linter/Formatter**: Biome
- **Language**: Modern JavaScript (ES6+)

## Code Style & Conventions

### Formatting
- **Indentation**: Tabs (not spaces)
- **Quotes**: Double quotes for strings
- **Line endings**: Unix (LF)
- Use Biome for all formatting and linting

### JavaScript Conventions
- Use ES6+ features (classes, arrow functions, async/await, destructuring)
- Use `import`/`export` syntax (ES modules)
- Prefer `const` over `let`, avoid `var`
- Use template literals for string interpolation
- Prefer functional array methods (`.map()`, `.filter()`, etc.)

### Architecture
- **Class-based design**: Use classes for logical groupings (Logger, FileManager, CommandHandler, etc.)
- **Static methods**: Use for utility functions that don't need instance state
- **Private methods**: Use `#` prefix for private class methods
- **Error handling**: Use custom `MicrotasticError` class with error codes
- **Async/await**: Prefer over `.then()` chains

### Naming Conventions
- **Classes**: PascalCase (e.g., `CommandHandler`, `FileManager`)
- **Constants**: UPPER_SNAKE_CASE for config objects (e.g., `CONFIG`, `MIME_TYPES`)
- **Variables/functions**: camelCase (e.g., `loadSettings`, `appPkg`)
- **Private class fields**: Prefix with `#` (e.g., `#log`, `#colors`)
- **Private module-level variables**: Prefix with `_` (e.g., `_activeContext`, `_batchPending`)
- **Unused variables**: Prefix with `_` if intentionally unused (but prefer removing them)

### File Structure
- Single entry point: `index.js`
- Template files in `/template/`
- Service worker template: `sw.tpl`

### Error Handling
- Throw `MicrotasticError` with descriptive messages and error codes
- Log errors using the `Logger` class
- Exit with appropriate codes (1 for known errors, 2 for unexpected)

### Async Patterns
- Use `async/await` consistently
- Handle promise rejections with try/catch
- Use `Promise.all()` for parallel operations when appropriate

### Dependencies
- Minimize external dependencies
- Use built-in Node.js modules where possible (`node:fs`, `node:http`, `node:path`, `node:url`)

## Commands & Scripts
- `npm run lint` - Run Biome linter/formatter
- `npm test` - Run unit tests
- Main CLI commands: `init`, `prep`, `dev`, `prod`, `version`

## Hot Reload
- DevServer supports hot reload via Server-Sent Events (SSE)
- Configurable via `hotReload: true/false` in `.microtastic` (default: true)
- Watches only the `app/` directory for file changes
- Automatically reloads browser when files change

## Best Practices
- Keep functions focused and single-purpose
- Use descriptive variable names
- Add comments only when code intent isn't clear
- Validate inputs early (fail fast)
- Clean up resources (close bundles, etc.)
- Use meaningful error messages

## Testing
- Unit tests in `/test/` directory using Node.js built-in test runner
- Run tests with `npm test`
- Test coverage: 159 tests covering all major classes and reactive system
  - Core classes: MicrotasticError, Logger, FileManager, DevServer, CommandHandler, Microtastic (40 tests)
  - Reactive system: Signals, computed, HTML utilities, CSS-in-JS, binding methods, components, lifecycle (119 tests)
- Manual testing via CLI commands: init, prep, dev, prod, version

## Reactive System (reactive.js)
- **Signals-based reactivity**: Fine-grained reactive state management
- **Signal naming**: Support for named signals for debugging (`Signals.create(0, undefined, "name")`)
- **peek() method**: Read signal values without tracking dependencies
- **Async computed**: `Signals.computedAsync()` for async operations (API calls, heavy computations)
  - Returns state object: `{ status, data, error, loading }`
  - Automatic cancellation when dependencies change
  - Uses dedicated context per execution to avoid pollution
- **Circular dependency detection**: Prevents infinite loops in computed signals with descriptive error messages
- **Debug mode**: `setDebugMode(true)` enables logging of all signal updates and computed recalculations
- **Batching**: Automatic batching in event handlers and manual batching with `Signals.batch()`
- **Module-level private variables**: Use `_` prefix (e.g., `_activeContext`, `_debugMode`, `_computeStack`)
- **Component lifecycle**: `state()` → `init()` → `render()` → `mount()`
  - `state()`: Returns initial state (auto-converted to signals)
  - `init()`: Called after state init, before render (optional) - create computed/async signals here
  - `render()`: Creates DOM from `template()` with `styles()`
  - `mount()`: Called after DOM mount (optional) - use for side effects
  - `onCleanup()`: Called during cleanup (optional)

## Notes
- This is a CLI tool, not a web application
- Focus on developer experience and clear error messages
- Keep the codebase simple and maintainable

## Rolldown Status
- **Not ready for production use** (as of v1.0.0-beta.46)
- Built-in CommonJS support produces only default exports, breaking named imports
- `@rollup/plugin-commonjs` is incompatible (plugin API incomplete)
- `esmExternalRequirePlugin` only handles external modules, not bundled dependencies
- Revisit when: stable v1.0.0 releases with proper CommonJS→ESM conversion
- Tracking issue: https://github.com/rolldown/rolldown/issues/6269

